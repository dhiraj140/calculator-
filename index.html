<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Site Diary / Measurement Book (Offline)</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111a2b;
      --muted: #9fb0ce;
      --text: #e8f0ff;
      --accent: #4cc9f0;
      --accent-2: #80ed99;
      --danger: #ff6b6b;
      --warn: #ffd166;
      --shadow: 0 10px 20px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(76,201,240,.15), transparent 60%),
                  radial-gradient(1200px 800px at 110% 10%, rgba(128,237,153,.13), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.35;
    }
    header{position:sticky;top:0;z-index:3;background:linear-gradient(180deg, rgba(11,18,32,.95), rgba(11,18,32,.7));backdrop-filter:saturate(140%) blur(6px);}
    .wrap{max-width:1100px;margin:auto;padding:14px;}
    .title{display:flex;gap:12px;align-items:center}
    .title h1{font-size:clamp(18px,4vw,24px);margin:0}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(76,201,240,.15);color:var(--accent);border:1px solid rgba(76,201,240,.35)}

    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow); border-radius:var(--radius)}
    .card h2{font-size:18px;margin:0 0 10px 0}
    .card .body{padding:16px}

    form{display:grid;gap:12px}
    .row{display:grid;gap:10px}
    @media(min-width:640px){
      .row.two{grid-template-columns:repeat(2,1fr)}
      .row.three{grid-template-columns:repeat(3,1fr)}
    }

    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input, textarea, select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03); color:var(--text);
      outline:none; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }
    textarea{min-height:84px; resize:vertical}
    input[type="date"]{padding:8px 10px}
    input[type="number"]{-moz-appearance: textfield}

    .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    button, .btn{
      appearance:none; border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:.15s transform ease, .15s filter ease; text-decoration:none; display:inline-flex; align-items:center; gap:8px
    }
    button:hover, .btn:hover{transform:translateY(-1px); filter:brightness(1.06)}
    .primary{border-color:rgba(76,201,240,.5); background:linear-gradient(180deg, rgba(76,201,240,.25), rgba(76,201,240,.12)); color:white}
    .danger{border-color:rgba(255,107,107,.5); background:linear-gradient(180deg, rgba(255,107,107,.25), rgba(255,107,107,.12))}
    .ghost{background:transparent}

    /* Table */
    .table-wrap{overflow:auto; max-height:60vh; padding:0 2px}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    thead th{position:sticky; top:0; z-index:2; background:rgba(11,18,32,.9); backdrop-filter:blur(6px);
      font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); padding:10px; text-align:left}
    tbody tr{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08)}
    tbody td{padding:10px; vertical-align:top}
    tbody tr{border-radius:12px; overflow:hidden}
    tbody tr td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
    .cell-mono{font-variant-numeric:tabular-nums}
    .tools{display:flex; gap:6px}
    .nowrap{white-space:nowrap}

    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between; padding:12px 16px; border-top:1px solid rgba(255,255,255,.06)}
    .toolbar .left, .toolbar .right{display:flex; gap:8px; align-items:center}
    .search{display:flex; align-items:center;gap:6px}
    .search input{min-width:220px}

    .muted{color:var(--muted)}
    .right small{color:var(--muted)}

    /* Print styles */
    @media print{
      header, .toolbar, .actions, .badge, .hide-print{display:none !important}
      body{background:#fff;color:#000}
      .card{border:none; box-shadow:none}
      .table-wrap{max-height:none; overflow:visible}
      thead th{background:#fff; color:#000; position:static}
      tbody tr{background:#fff; border:1px solid #000}
      a{color:#000;text-decoration:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <h1>Site Diary / Measurement Book</h1>
      <span class="badge">Offline · Auto‑save</span>
    </div>
  </header>

  <main class="wrap grid">

    <section class="card" aria-labelledby="formTitle">
      <div class="body">
        <h2 id="formTitle">Daily Entry</h2>
        <form id="entryForm">
          <div class="row three">
            <div>
              <label for="date">Date</label>
              <input type="date" id="date" name="date" required />
            </div>
            <div>
              <label for="location">Location / Site Name</label>
              <input type="text" id="location" name="location" placeholder="Site or project name" required />
            </div>
            <div>
              <label for="manpower">Manpower count</label>
              <input type="number" id="manpower" name="manpower" inputmode="numeric" min="0" step="1" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="work">Work Description</label>
              <textarea id="work" name="work" placeholder="Describe work carried out"></textarea>
            </div>
          </div>

          <div class="row two">
            <div>
              <label for="measurements">Measurements</label>
              <textarea id="measurements" name="measurements" placeholder="Chainage, lengths, volumes, etc."></textarea>
            </div>
            <div>
              <label for="materials">Materials used</label>
              <textarea id="materials" name="materials" placeholder="Cement, steel, sand, etc."></textarea>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="remarks">Remarks <span class="muted">(optional)</span></label>
              <textarea id="remarks" name="remarks" placeholder="Notes, issues, weather, approvals..."></textarea>
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="primary" id="saveBtn">Save entry</button>
            <button type="button" id="resetBtn" class="ghost">Clear form</button>
            <button type="button" id="printBtn" class="ghost hide-print" title="Print-friendly view">Print</button>
          </div>
          <input type="hidden" id="editId" />
        </form>
      </div>
      <div class="toolbar">
        <div class="left">
          <button type="button" id="exportCsv" class="btn">Export CSV (.csv)</button>
          <button type="button" id="exportXls" class="btn">Export Excel (.xls)</button>
        </div>
        <div class="right">
          <div class="search">
            <input type="search" id="search" placeholder="Search entries…"/>
          </div>
          <button type="button" id="sortDate" class="btn">Sort by Date <span id="sortDir" class="muted">(newest)</span></button>
          <small id="count" class="muted">0 entries</small>
        </div>
      </div>
    </section>

    <section class="card" aria-labelledby="listTitle">
      <div class="body">
        <h2 id="listTitle" style="margin-bottom:6px">Saved Entries</h2>
        <div class="table-wrap">
          <table id="entriesTable">
            <thead>
              <tr>
                <th class="nowrap">Date</th>
                <th>Location</th>
                <th>Work Description</th>
                <th>Measurements</th>
                <th class="nowrap">Manpower</th>
                <th>Materials</th>
                <th>Remarks</th>
                <th class="nowrap">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <script>
    // --- Utilities ---
    const LS_KEY_ENTRIES = 'siteDiary.entries.v1';
    const LS_KEY_DRAFT = 'siteDiary.draft.v1';

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function todayISO(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const d2 = new Date(d.getTime() - off*60000);
      return d2.toISOString().slice(0,10);
    }

    function loadEntries(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY_ENTRIES)||'[]'); }
      catch{ return []; }
    }
    function saveEntries(arr){ localStorage.setItem(LS_KEY_ENTRIES, JSON.stringify(arr)); }

    function loadDraft(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY_DRAFT)||'{}'); }
      catch{ return {}; }
    }
    function saveDraft(d){ localStorage.setItem(LS_KEY_DRAFT, JSON.stringify(d)); }
    function clearDraft(){ localStorage.removeItem(LS_KEY_DRAFT); }

    function uid(){ return 'id_' + Math.random().toString(36).slice(2,9) + Date.now().toString(36); }

    function sanitize(str){ return (str||'').toString().replace(/\s+/g,' ').trim(); }

    // --- State ---
    let entries = loadEntries();
    let sortNewestFirst = true;

    // --- Form setup ---
    const form = $('#entryForm');
    const fields = ['date','location','work','measurements','manpower','materials','remarks'];

    function applyDraft(){
      const draft = loadDraft();
      fields.forEach(f=>{
        if(draft[f]!==undefined) $('#'+f).value = draft[f];
      });
      if(!$('#date').value) $('#date').value = todayISO();
    }

    function captureDraft(){
      const d = {}; fields.forEach(f=> d[f] = $('#'+f).value); saveDraft(d);
    }

    fields.forEach(f=> $('#'+f).addEventListener('input', debounce(captureDraft, 300)));

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), ms); } }

    function resetForm(){
      form.reset();
      $('#date').value = todayISO();
      $('#editId').value = '';
      clearDraft();
    }

    $('#resetBtn').addEventListener('click', resetForm);

    $('#printBtn').addEventListener('click', ()=> window.print());

    // --- CRUD ---
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      data.date = data.date || todayISO();
      data.location = sanitize(data.location);
      data.work = (data.work||'').trim();
      data.measurements = (data.measurements||'').trim();
      data.materials = (data.materials||'').trim();
      data.remarks = (data.remarks||'').trim();
      data.manpower = data.manpower? Number(data.manpower) : 0;

      const editId = $('#editId').value;
      if(editId){
        entries = entries.map(it => it.id===editId ? {...it, ...data} : it);
      }else{
        entries.push({id: uid(), createdAt: Date.now(), ...data});
      }
      saveEntries(entries);
      clearDraft();
      resetForm();
      render();
    });

    function editEntry(id){
      const it = entries.find(e=>e.id===id);
      if(!it) return;
      fields.forEach(f=> $('#'+f).value = (it[f] ?? ''));
      $('#editId').value = id;
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function deleteEntry(id){
      if(!confirm('Delete this entry?')) return;
      entries = entries.filter(e=>e.id!==id);
      saveEntries(entries);
      render();
    }

    // --- Render table ---
    function render(){
      // Search filter
      const q = $('#search').value?.toLowerCase().trim();
      let rows = entries.slice();
      rows.sort((a,b)=> sortNewestFirst ? (b.date.localeCompare(a.date) || b.createdAt - a.createdAt)
                                       : (a.date.localeCompare(b.date) || a.createdAt - b.createdAt));
      if(q){
        rows = rows.filter(r => Object.values(r).some(v => (v+'').toLowerCase().includes(q)));
      }
      const tbody = $('#entriesTable tbody');
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td class="cell-mono">${r.date}</td>
          <td>${escapeHtml(r.location)}</td>
          <td>${nl2br(escapeHtml(r.work))}</td>
          <td>${nl2br(escapeHtml(r.measurements))}</td>
          <td class="cell-mono">${Number(r.manpower)||0}</td>
          <td>${nl2br(escapeHtml(r.materials))}</td>
          <td>${nl2br(escapeHtml(r.remarks))}</td>
          <td class="tools nowrap">
            <button type="button" onclick="editEntry('${r.id}')">Edit</button>
            <button type="button" class="danger" onclick="deleteEntry('${r.id}')">Delete</button>
          </td>
        </tr>`).join('');
      $('#count').textContent = `${rows.length} ${rows.length===1?'entry':'entries'}`;
    }

    function nl2br(s){ return (s||'').replace(/\n/g,'<br>'); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    // --- Search + Sort ---
    $('#search').addEventListener('input', render);
    $('#sortDate').addEventListener('click', ()=>{
      sortNewestFirst = !sortNewestFirst;
      $('#sortDir').textContent = sortNewestFirst ? '(newest)' : '(oldest)';
      render();
    });

    // --- Export ---
    function toFlatRows(arr){
      return arr.map(({date,location,work,measurements,manpower,materials,remarks})=>({date,location,work,measurements,manpower,materials,remarks}));
    }

    function exportCSV(){
      const rows = toFlatRows(entries);
      const headers = Object.keys(rows[0]||{date:'',location:'',work:'',measurements:'',manpower:'',materials:'',remarks:''});
      const csv = [headers.join(',')]
        .concat(rows.map(r=> headers.map(h=> csvCell(r[h])).join(',')))
        .join('\n');
      downloadFile(csv, `site-diary-${todayISO()}.csv`, 'text/csv;charset=utf-8');
    }

    function csvCell(v){
      const s = (v==null? '': String(v));
      if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
      return s;
    }

    function exportXLS(){
      // Excel-compatible .XLS via HTML table (opens in Excel). For strict .xlsx we can embed a library if needed.
      const rows = toFlatRows(entries);
      const headers = Object.keys(rows[0]||{date:'',location:'',work:'',measurements:'',manpower:'',materials:'',remarks:''});
      const esc = s=> String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
      let html = '<table><thead><tr>' + headers.map(h=>`<th>${esc(h)}</th>`).join('') + '</tr></thead><tbody>' +
        rows.map(r=> '<tr>' + headers.map(h=>`<td>${esc(r[h])}</td>`).join('') + '</tr>').join('') +
        '</tbody></table>';
      const content = `\ufeff<html><head><meta charset="utf-8"></head><body>${html}</body></html>`;
      downloadFile(content, `site-diary-${todayISO()}.xls`, 'application/vnd.ms-excel');
    }

    function downloadFile(content, filename, mime){
      const blob = new Blob([content], {type:mime});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    }

    $('#exportCsv').addEventListener('click', exportCSV);
    $('#exportXls').addEventListener('click', exportXLS);

    // --- Initialization ---
    (function init(){
      // Default today
      $('#date').value = todayISO();
      // Apply unsaved draft if any
      applyDraft();
      // Render existing
      render();
      // Expose edit/delete for inline onclick
      window.editEntry = editEntry;
      window.deleteEntry = deleteEntry;
    })();
  </script>
</body>
</html>
